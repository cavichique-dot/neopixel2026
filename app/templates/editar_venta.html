{% extends "base.html" %}
{% block content %}
<div class="p-4 md:p-8 max-w-full">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
    <h2 class="text-4xl md:text-5xl font-black text-cyan-400">EDITAR VENTA #{{ venta.id }}</h2>
    <a href="{{ url_for('sales.ventas') }}" class="btn text-xl md:text-2xl px-8 py-4 whitespace-nowrap">VOLVER A VENTAS</a>
  </div>

  <div class="overflow-x-auto -mx-4 md:mx-0">
    <div class="inline-block min-w-full align-middle">
      <div class="overflow-hidden rounded-xl shadow-2xl border border-slate-700">
        <form method="POST">
          <table class="min-w-full divide-y divide-slate-700">
            <thead class="bg-gradient-to-r from-cyan-600 to-blue-700">
              <tr>
                <th class="px-4 py-4 text-left text-sm font-bold text-white">Producto</th>
                <th class="px-4 py-4 text-center text-sm font-bold text-white">Cantidad</th>
                <th class="px-4 py-4 text-right text-sm font-bold text-white">Precio</th>
                <th class="px-4 py-4 text-right text-sm font-bold text-white">Subtotal</th>
                <th class="px-4 py-4 text-center text-sm font-bold text-white">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-700">
              {% for item in items %}
              <tr class="hover:bg-slate-700/50 transition">
                <td class="px-4 py-4">
                  <select name="items[]" required class="w-full px-4 py-3 text-base rounded-lg bg-slate-800 text-white border border-slate-600">
                    {% for p in productos %}
                      <option value="{{ p.id }}" {% if p.id == item.producto_id %}selected{% endif %} data-precio="{{ p.precio }}">
                        {{ p.nombre }} - ${{ "{:,.0f}".format(p.precio) }}
                      </option>
                    {% endfor %}
                  </select>
                </td>
                <td class="px-4 py-4 text-center">
                  <input type="number" name="cantidades[]" value="{{ item.cantidad }}" min="1" required class="w-24 px-4 py-3 text-base rounded-lg bg-slate-800 text-white text-center">
                </td>
                <td class="px-4 py-4 text-right text-cyan-300 font-bold">${{ "{:,.0f}".format(item.precio) }}</td>
                <td class="px-4 py-4 text-right text-cyan-400 font-bold text-xl">
                  ${{ "{:,.0f}".format(item.cantidad * item.precio) }}
                </td>
                <td class="px-4 py-4 text-center">
                  <button type="button" onclick="this.parentElement.parentElement.remove(); calcTotal()" class="text-red-400 hover:text-red-300 font-bold">Eliminar</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- BOTÓN PARA AGREGAR MÁS PRODUCTOS -->
          <div class="text-center mt-6">
            <button type="button" onclick="addItemRow()" class="text-cyan-400 hover:text-cyan-300 text-xl font-bold underline">
              + Agregar producto
            </button>
          </div>

          <!-- MÉTODO DE PAGO GENERAL -->
          <div class="mt-10 bg-white/5 rounded-2xl p-8 border border-white/20">
            <p class="text-2xl font-black text-white mb-6 text-center">MÉTODO DE PAGO GENERAL</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
              <label class="cursor-pointer">
                <input type="radio" name="metodo_pago" value="efectivo" {% if venta.metodo_pago == 'efectivo' %}checked{% endif %} class="sr-only peer">
                <div class="bg-green-600/20 border-4 border-green-500 rounded-2xl p-8 text-center text-green-400 font-black text-2xl peer-checked:bg-green-600 peer-checked:text-white transition-all">
                  EFECTIVO
                </div>
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="metodo_pago" value="transferencia" {% if venta.metodo_pago == 'transferencia' %}checked{% endif %} class="sr-only peer">
                <div class="bg-blue-600/20 border-4 border-blue-500 rounded-2xl p-8 text-center text-blue-400 font-black text-2xl peer-checked:bg-blue-600 peer-checked:text-white transition-all">
                  TRANSFERENCIA
                </div>
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="metodo_pago" value="deposito" {% if venta.metodo_pago == 'deposito' %}checked{% endif %} class="sr-only peer">
                <div class="bg-purple-600/20 border-4 border-purple-500 rounded-2xl p-8 text-center text-purple-400 font-black text-2xl peer-checked:bg-purple-600 peer-checked:text-white transition-all">
                  DEPÓSITO
                </div>
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="metodo_pago" value="combinado" {% if venta.metodo_pago == 'combinado' %}checked{% endif %} class="sr-only peer">
                <div class="bg-orange-600/20 border-4 border-orange-500 rounded-2xl p-8 text-center text-orange-400 font-black text-2xl peer-checked:bg-orange-600 peer-checked:text-white transition-all">
                  COMBINADO
                </div>
              </label>
            </div>
          </div>

          <!-- ABONADO ACTUAL (informativo) -->
          <div class="mt-10 bg-gradient-to-r from-green-900/50 to-emerald-900/50 rounded-2xl p-8 border border-green-600 text-center">
            <p class="text-2xl font-black text-green-300 mb-4">ABONADO ACTUAL</p>
            <p class="text-6xl font-black text-green-400">${{ "{:,.0f}".format(venta.abonado) }}</p>
            <p class="text-xl text-green-200 mt-4">Puedes agregar más abonos desde la lista de ventas</p>
          </div>

          <!-- TOTAL Y BOTÓN -->
          <div class="text-right mt-10">
            <p class="text-5xl font-black text-cyan-400 mb-8">TOTAL: $<span id="total-display">{{ "{:,.0f}".format(venta.total) }}</span></p>
            <button type="submit" class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white px-20 py-6 rounded-xl text-3xl font-black shadow-2xl hover:shadow-cyan-500/50 transform hover:scale-105 transition">
              ACTUALIZAR VENTA
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function addItemRow() {
  const tbody = document.querySelector('tbody');
  const row = document.createElement('tr');
  row.className = 'hover:bg-slate-700/50 transition';
  row.innerHTML = `
    <td class="px-4 py-4">
      <select name="items[]" required class="w-full px-4 py-3 text-base rounded-lg bg-slate-800 text-white border border-slate-600">
        <option value="" disabled selected>Selecciona producto</option>
        {% for p in productos %}
          <option value="{{ p.id }}" data-precio="{{ p.precio }}">{{ p.nombre }} - ${{ "{:,.0f}".format(p.precio) }}</option>
        {% endfor %}
      </select>
    </td>
    <td class="px-4 py-4 text-center">
      <input type="number" name="cantidades[]" value="1" min="1" required class="w-24 px-4 py-3 text-base rounded-lg bg-slate-800 text-white text-center">
    </td>
    <td class="px-4 py-4 text-right text-cyan-300 font-bold">$0</td>
    <td class="px-4 py-4 text-right text-cyan-400 font-bold text-xl">$0</td>
    <td class="px-4 py-4 text-center">
      <button type="button" onclick="this.parentElement.parentElement.remove(); calcTotal()" class="text-red-400 hover:text-red-300 font-bold">Eliminar</button>
    </td>
  `;
  tbody.appendChild(row);
  calcTotal();
}

function calcTotal() {
  let total = 0;
  document.querySelectorAll('tbody tr').forEach(row => {
    const select = row.querySelector('select');
    const cantInput = row.querySelector('input[type=number]');
    if (select && cantInput && select.selectedIndex > 0) {
      const precio = parseFloat(select.selectedOptions[0].dataset.precio);
      const cant = parseInt(cantInput.value) || 0;
      total += precio * cant;
    }
  });
  document.getElementById('total-display').textContent = total.toLocaleString();
}

// Calcular al cargar la página
calcTotal();
</script>
{% endblock %}