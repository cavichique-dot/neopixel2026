{% extends "base.html" %}
{% block content %}
<div class="bg-white/10 backdrop-blur-xl rounded-2xl p-10 shadow-2xl">
  <h2 class="text-5xl font-black text-cyan-400 text-center mb-10">+ NUEVA VENTA</h2>
  <form method="POST" class="space-y-8">
   
    <div>
      <label class="text-xl font-bold text-white">Cliente</label>
      <select name="cliente" required class="w-full mt-2 px-6 py-4 text-xl rounded-xl bg-slate-800 text-white border border-slate-600 focus:border-cyan-400">
        {% for c in clientes %}
          <option value="{{ c.id }}">{{ c.nombre }}{% if c.telefono %} ({{ c.telefono }}){% endif %}</option>
        {% endfor %}
      </select>
    </div>

    <div id="items-container" class="space-y-4"></div>

    <!-- MÉTODOS DE PAGO GENERAL DE LA VENTA -->
    <div class="bg-white/5 rounded-2xl p-8 border border-white/20">
      <p class="text-2xl font-black text-white mb-6 text-center">MÉTODO DE PAGO GENERAL</p>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <label class="cursor-pointer">
          <input type="radio" name="metodo_pago" value="efectivo" checked class="sr-only peer">
          <div class="bg-green-600/20 border-4 border-green-500 rounded-2xl p-8 text-center text-green-400 font-black text-2xl peer-checked:bg-green-600 peer-checked:text-white transition-all">
            EFECTIVO
          </div>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="metodo_pago" value="transferencia" class="sr-only peer">
          <div class="bg-blue-600/20 border-4 border-blue-500 rounded-2xl p-8 text-center text-blue-400 font-black text-2xl peer-checked:bg-blue-600 peer-checked:text-white transition-all">
            TRANSFERENCIA
          </div>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="metodo_pago" value="deposito" class="sr-only peer">
          <div class="bg-purple-600/20 border-4 border-purple-500 rounded-2xl p-8 text-center text-purple-400 font-black text-2xl peer-checked:bg-purple-600 peer-checked:text-white transition-all">
            DEPÓSITO
          </div>
        </label>
        <label class="cursor-pointer">
          <input type="radio" name="metodo_pago" value="combinado" class="sr-only peer">
          <div class="bg-orange-600/20 border-4 border-orange-500 rounded-2xl p-8 text-center text-orange-400 font-black text-2xl peer-checked:bg-orange-600 peer-checked:text-white transition-all">
            COMBINADO
          </div>
        </label>
      </div>
    </div>

    <!-- NUEVA SECCIÓN: ABONO INICIAL CON MÉTODO ESPECÍFICO -->
    <div class="bg-gradient-to-r from-green-900/50 to-emerald-900/50 rounded-2xl p-8 border border-green-600">
      <p class="text-2xl font-black text-green-300 mb-6 text-center">ABONO INICIAL (ANTICIPO)</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <label class="text-xl font-bold text-white">Monto del anticipo</label>
          <input type="number" name="abono_inicial" value="0" min="0" step="0.01" 
                 class="w-full mt-2 px-6 py-4 text-2xl rounded-xl bg-slate-800 text-white text-center font-bold focus:border-green-400 border border-slate-600">
        </div>
        <div>
          <label class="text-xl font-bold text-white">Método del anticipo</label>
          <select name="metodo_abono_inicial" class="w-full mt-2 px-6 py-4 text-xl rounded-xl bg-slate-800 text-white border border-slate-600 focus:border-green-400">
            <option value="efectivo">Efectivo</option>
            <option value="transferencia">Transferencia</option>
            <option value="deposito">Depósito</option>
            <option value="combinado">Combinado</option>
          </select>
        </div>
      </div>
      <p class="text-center text-green-200 text-lg mt-4">Si no hay anticipo, deja en 0</p>
    </div>

    <div class="text-right">
      <p class="text-5xl font-black text-cyan-400 mb-6">TOTAL: $<span id="total">0</span></p>
      <button type="submit" class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white px-20 py-6 rounded-xl text-3xl font-black shadow-2xl hover:shadow-cyan-500/50 transform hover:scale-105 transition">
        CREAR VENTA
      </button>
    </div>
  </form>

  <button type="button" onclick="addItem()" class="mt-10 text-cyan-400 hover:text-cyan-300 text-xl font-bold underline">
    + Agregar otro producto
  </button>
</div>

<script>
function addItem() {
  const container = document.getElementById('items-container');
  const row = document.createElement('div');
  row.className = 'grid grid-cols-12 gap-4 bg-white/5 p-6 rounded-xl items-center';
  row.innerHTML = `
    <div class="col-span-7">
      <select name="items[]" required class="w-full px-6 py-4 text-xl rounded-xl bg-slate-800 text-white" onchange="calc()">
        <option value="" disabled selected>Selecciona producto</option>
        {% for p in productos %}
          <option value="{{ p.id }}" data-precio="{{ p.precio }}">{{ p.nombre }} - ${{ p.precio|round(0)|int }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-span-3">
      <input type="number" name="cantidades[]" value="1" min="1" required class="w-full px-6 py-4 text-xl rounded-xl bg-slate-800 text-white text-center" oninput="calc()">
    </div>
    <div class="col-span-2 text-right text-2xl font-bold text-cyan-400 subtotal">$0</div>
    <input type="hidden" name="precios[]" value="">
  `;
  container.appendChild(row);
  calc();
}

function calc() {
  let total = 0;
  document.querySelectorAll('#items-container > div').forEach(r => {
    const select = r.querySelector('select');
    if (select && select.selectedIndex > 0) {
      const cant = parseInt(r.querySelector('input[type=number]').value) || 0;
      const precio = parseFloat(select.selectedOptions[0].dataset.precio);
      const sub = cant * precio;
      r.querySelector('.subtotal').textContent = '$' + sub.toLocaleString();
      r.querySelector('input[type=hidden]').value = precio;
      total += sub;
    }
  });
  document.getElementById('total').textContent = total.toLocaleString();
}

// Agregar primer producto al cargar
addItem();
</script>
{% endblock %}